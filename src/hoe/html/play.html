<!DOCTYPE html>
<html>
    <head>
        <title>Static Image</title>
        <meta charset="UTF-8">
        <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="stylesheet" href="ol.css" type="text/css">
        <style>html, body {width:100%;height:100%;margin:0;padding:0;border:0;overflow:hidden;font-size:100%;font-family:monospace;color:black;}</style>
        <script src="ol.js"></script>

        <script src="canvas-video-player.js"></script>
        <script>
            function scrollTopLeft() {
                var d = document.body;
                d.scrollLeft = 0;
                d.scrollTop = 0;
            }
            ;
            document.addEventListener('gesturestart', function (e) {
                scrollTopLeft();
                e.preventDefault();
            });
            document.addEventListener('touchmove',
                    function (event) {
                        scrollTopLeft();
                        event.preventDefault();
                    }, false);
        </script>

        <script>
            // Debug.
            //var debug = true;
            var debug = '#!DEBUG_ENABLED!#' === 'true' ? true : false;
            function toDebug(msg) {
                if (debug)
                    console.log('DEBUG: ' + msg);
            }
            ;

            function init() {
                toDebug('init();');
            }
            ;

        </script>

        <style>
            /* Link formázása gombbá. */
            .link-button {
                pointer-events: auto;
                background-color: black;
                border: 1px solid white;
                border-radius: 2px;
                color: black;
                padding: 10px 10px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 15px;
                margin: 2px 2px;
                -webkit-transition-duration: 0.15s;
                transition-duration: 0.15s;
                cursor: default;
                color: white;
                font-family: monospace;
                -webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;
            }
            .link-button:hover {
                background-color: white;
                color: black;
            }
            .link-button:active {
                text-decoration: underline;
            }
            .solid {
                background-color: lightgray;
            }
            .fitwidth {
                width:1%;
                white-space:nowrap;
            }
            .expandwidth {
                width:100%;
            }
            .header {
                border-bottom: 1px solid black;
            }
            .footer {
                border-top:1px solid black;
            }
            .sider {
                border-top:1px solid black;
                border-right:1px solid black;
            }
            .chat-messages {
                cursor: default;
                width: 40%;
                height: 70%;
                pointer-events: none;
                -webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;
                background: rgba(255, 255, 255, .7);
            }
        </style>
        
        
        
        <script src="iscroll-zoom.js"></script>
        <script>

            var myScroll;

            function loaded() {
                myScroll = new IScroll('#wrapper', {
                    //startX: -359,
                    //startY: -85,
                    //ignoreBoundaries: true,
                    startX: 0,
                    startY: 0,
                    scrollY: true,
                    scrollX: true,
                    freeScroll: true,
                    zoom: true,
                    mouseWheel: true,
                    wheelAction: 'zoom',
                    startZoom: 1,
                    zoomMin: .5,
                    zoomMax: 4,
                    tap: true,
                    bounce: true,
                });

                function onClick(evt) {
                    var x = evt.pageX;
                    var y = evt.pageY;
                    console.log('click', 'x:', evt.x, 'y:', evt.y);
                    myScroll.zoom(4, x, y, 1000);
                }
                
                // smooth zoom-hoz az iscroll-zoom.js fájlban kell a _wheelZoom metódus utolsó sorában átírni this.zoom(deltaScale, e.pageX, e.pageY, 0);->this.zoom(deltaScale, e.pageX, e.pageY, 500);
                
                function onWheel(evt) {
                    var delta = evt.wheelDelta;
                    var d = delta > 0 ? 1 : -1;
                    //console.log('wheel','delta:',delta,myScroll.scale);
                    //myScroll.zoom(myScroll.scale+d*1.2, evt.x, evt.y, 1000);
                }

                //myScroll.on('tap', onClick);

                document.getElementById('scroller').addEventListener('tap', onClick, false);
                document.getElementById('scroller').addEventListener('wheel', onWheel, false);
                
                canvasVideo.play();
            }

        // document.addEventListener('touchmove', function (e) { e.preventDefault(); }, isPassive() ? {
        // 	capture: false,
        // 	passive: false
        // } : false);

        </script>

        <style type="text/css">
            * {
                -webkit-box-sizing: border-box;
                -moz-box-sizing: border-box;
                box-sizing: border-box;
            }

            html {
                -ms-touch-action: none;
            }

            body,ul,li {
                padding: 0;
                margin: 0;
                border: 0;
            }

            body {
                font-size: 12px;
                font-family: ubuntu, helvetica, arial;
                overflow: hidden; /* this is important to prevent the whole page to bounce */
            }

            #wrapper {
                position: absolute;
                z-index: 1;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                background: #555;
                overflow: hidden;
            }

            #scroller {
                position: absolute;
                z-index: 1;
                width: 2048px;
                height: 2048px;
                background: url(tile/test2.jpg);
                -webkit-tap-highlight-color: rgba(0,0,0,0);
                -webkit-transform: translateZ(0);
                -moz-transform: translateZ(0);
                -ms-transform: translateZ(0);
                -o-transform: translateZ(0);
                transform: translateZ(0);
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                -webkit-text-size-adjust: none;
                -moz-text-size-adjust: none;
                -ms-text-size-adjust: none;
                -o-text-size-adjust: none;
                text-size-adjust: none;
            }
        </style>
        
        
        
    </head>
    <!--
    <body style="zoom: 1">
    <body>
    <body onload="canvasVideo.play()">
    -->
    <body onload="loaded()">
        
        <!--        <div class="video-wrapper js-video-wrapper">
            <div class="video-responsive">-->
                <video class="video js-video" muted="" style="display: none;">
                    <source src="http://www.quirksmode.org/html5/videos/big_buck_bunny.webm" type="video/webm">
                    <source src="http://www.quirksmode.org/html5/videos/big_buck_bunny.mp4" type="video/mp4">
                    <source src="http://www.quirksmode.org/html5/videos/big_buck_bunny.ogv" type="video/ogg">
                    Your browser does not support HTML5 video.
                </video>
<!--
                <canvas class="canvas js-canvas" width="800" height="450"></canvas>
-->
<!--            </div>
        </div>
-->

        
        <div id="wrapper">
            <div id="scroller">
                <div style="background-color: green;width: 20px;height: 20px;"></div>
                <canvas class="canvas js-canvas" width="800" height="450"></canvas>
            </div>
        </div>
        
        <script>
        var canvasVideo = new CanvasVideoPlayer({
                                videoSelector: '.js-video',
                                canvasSelector: '.js-canvas',
                                //canvasSelector: canvas,
                                //canvasSelector: '.ol-unselectable',
                                //canvasSelector: '.map',
                                //timelineSelector: '.js-timeline',
                                audio: true,
                            });
        </script>

        <div style='width:100%;height:100%;pointer-events:none;position:absolute;z-index:1'>
            <!-- Fő táblázat a GUI elemek igazításához. -->
            <table border=0 cellSpacing=0 cellPadding=0 style='width:100%;height:100%;'>
                <tr style='width:100%;'>
                    <td style='padding:5px;'><b><big><div id=userNameDiv style='cursor:default;pointer-events:auto;background-color:gray;white-space:nowrap;width:auto;-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;'></div></big></b></td>
                    <td style='width:100%;'></td>
                    <td align=right><a href='/logout' class='link-button'>#!LOGOUT!#</a></td></tr>
                <tr style='height:100%;'>
                    <td colSpan=3 vAlign=bottom> <div id='chatMsgBox' class='chat-messages' style='display: table-cell; vertical-align: bottom;margin-left:5px;overflow:hidden;max-width:20%;max-height:70%;'></div></td>
                </tr>
                <tr>
                    <td colSpan=3>
                        <table border=0 cellSpacing=0 cellPadding=0 style='width:100%;height:100%;'>
                            <tr style='pointer-events:auto;cursor:default;background-color:gray;width:100%;'>
                                <td style='padding:5px;border-top:1px solid white;-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;'>
                                    #!MESSAGE!#:
                                </td>
                                <td style='width:100%;padding:5px;border-top:1px solid white;'>
                                    <input type='text' id='chatInput' maxlength='100' style='width:calc(100% - 10px);'>
                                </td>
                                <td style='padding:5px;border-top:1px solid white;'>
                                    <input id='sendChatMsgButton' type='button' value='#!SEND_MESSAGE!#'>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>


        <script>
            // Üzenet érkezett.
            function isJSON(text) {
                try {
                    JSON.parse(text);
                    return true;
                } catch (error) {
                    return false;
                }
            }
            ;
            var handleResponse = function (responseText) {
                if ('' !== responseText)
                    toDebug(responseText);
                if ('' === responseText || !isJSON(responseText))
                    return;
                // Üzenet átalakítása.
                var response = JSON.parse(responseText);
                for (var i in response) {
                    var o = response[i];
                    switch (o['a']) {
                        // Játékállapotváltozás érkezett (GameStateChanged).
                        case 'gsc':
                            toDebug('game state changed to: ' + o['d']['state']);
                            var state = o['d']['state'];
                            // Objektumok letöltése (GetSceneData).
                            sendToServer(JSON.stringify({a: 'gsd', d: {}}));
                            break;
                            // Átirányítás érkezett (ReDirect).
                        case 'rd':
                            toDebug('redirected to: ' + o['d']['url']);
                            window.location.href = o['d']['url'];
                            break;
                            // Chat üzenet érkezett (ChatMessage).
                        case 'cm':
                            var cmb = document.getElementById('chatMsgBox');
                            var count = (cmb.innerHTML.match(/<br>/g) || []).length;
                            if (count === messagesCount)
                                cmb.innerHTML = cmb.innerHTML.substring(cmb.innerHTML.indexOf('<br>') + 4);
                            if (downloadinMessages) {
                                cmb.innerHTML = "";
                                downloadinMessages = false;
                            }
                            cmb.innerHTML = cmb.innerHTML + '<b><u>' + o['d']['user'] + '</u></b>: ' + unescape(o['d']['msg']) + '<br>';
                            cmb.scrollTop = cmb.scrollHeight;
                            break;
                    }
                }
            };
            // Long-polling.
            var syncNeeded = true;
            var lp = function () {
                toDebug('openResponseChannel()');
                var xhrlp = new XMLHttpRequest();
                xhrlp.open('POST', '/play', true);
                xhrlp.responseType = 'text';
                xhrlp.onreadystatechange = function (oEvent) {
                    if (xhrlp.readyState === 4) {
                        if (xhrlp.status === 200) {
                            handleResponse(xhrlp.responseText);
                        } else {
                            toDebug('Error:', xhrlp.statusText);
                            syncNeeded = true;
                            xhrlp.abort();
                        }
                        lp();
                    }
                };
                xhrlp.timeout = 0;

                // Ha megszakadt a kapcsolat, vagy elsőként küldünk üzenetet akkor szinkronizáljuk az adatokat.
                if (syncNeeded) {
                    syncNeeded = false;
                    syncData();
                }

                // Üres üzenet küldése a válaszcsatornához.
                xhrlp.send('');
            };

            // Üzenet küldése a szervernek.
            var sendToServer = function (text) {
                toDebug('sendToServer(' + text + ');');
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/play', true);
                xhr.responseType = 'text';
                xhr.onload = function () {
                    handleResponse(xhr.responseText);
                };
                xhr.send(text);
            };
        </script>


        <script>
            var chatMsgBox = document.getElementById('chatMsgBox');
            var chatInput = document.getElementById('chatInput');
            chatInput.focused = false;
            chatInput.hasFocus = function () {
                return this.focused;
            };
            chatInput.onfocus = function () {
                this.focused = true;
            };
            chatInput.onblur = function () {
                this.focused = false;
            };
            var sendChatMsgButton = document.getElementById('sendChatMsgButton');
            var userNameDiv = document.getElementById('userNameDiv');
            userNameDiv.innerHTML = unescape('#!PLAYER_NAME!#');
            var sendMsgFunc = function () {
                if ('' !== chatInput.value) {
                    sendToServer(JSON.stringify({a: 'cm', d: {msg: escape(chatInput.value)}}));
                    chatInput.value = '';
                }
            };
            sendChatMsgButton.onclick = function () {
                sendMsgFunc();
            };
            // Enter lenyomása az üzenet beírásához/elküldéséhez.
            document.body.addEventListener('keydown', function (e) {
                if (13 === e.keyCode) {
                    if (!chatInput.hasFocus()) {
                        chatInput.focus();
                        return;
                    }
                    sendMsgFunc();
                    chatInput.blur();
                }
            });
        </script>

        <script>
            chatMsgBox.innerHTML = unescape('#!DOWNLOADING_CHAT_MESSAGES!#');
            var downloadinMessages = true;
            // Egyszerre megjelenő üzenetek száma.
            var messagesCount = 20;

            // Játékadatok szinkronizálása.
            function syncData() {
                // Chat üzenetek letöltése (GetChatMessages).
                sendToServer(JSON.stringify({a: 'gcm', d: {mc: messagesCount}}));
                // Játékállapot letöltése (GetGameState).
                sendToServer(JSON.stringify({a: 'ggs', d: {}}));
            }

            // Long-pollin megkezdése.
            lp();

        </script>

    </body>
</html>