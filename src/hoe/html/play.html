<!DOCTYPE html>
<html>
    <head>
        <title>#!PAGE_TITLE!#</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/logout-link.css">
        <link rel="stylesheet" href="css/chat.css">
        <link rel="stylesheet" href="css/ui.css">
        
        <script src="js/debug.js"></script>
        <script src="js/canvas-video-player.js"></script>
        <script src="js/scroll-to-left.js"></script>
        <script src="js/long-polling.js"></script>

        
        <script src="js/iscroll-zoom.js"></script>
        <script>

            var myScroll;

            function loaded() {
                myScroll = new IScroll('#wrapper', {
                    startX: 0,
                    startY: 0,
                    scrollY: true,
                    scrollX: true,
                    freeScroll: true,
                    zoom: true,
                    mouseWheel: true,
                    wheelAction: 'zoom',
                    startZoom: 1,
                    zoomMin: .5,
                    zoomMax: 4,
                    tap: true,
                    bounce: true
                });

                function onClick(evt) {
                    var x = evt.pageX;
                    var y = evt.pageY;
                    console.log('click', 'x:', x, 'y:', y);
                }
                
                document.getElementById('scroller').addEventListener('tap', onClick, false);
                
                canvasVideo.play();
            }

        </script>

        <style type="text/css">
            * {
                -webkit-box-sizing: border-box;
                -moz-box-sizing: border-box;
                box-sizing: border-box;
            }

            html {
                -ms-touch-action: none;
            }

            #wrapper {
                position: absolute;
                z-index: 1;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                background: #555;
                overflow: hidden;
            }

            #scroller {
                position: absolute;
                z-index: 1;
                width: 2048px;
                height: 2048px;
                background: url(tile/test2.jpg);
                -webkit-tap-highlight-color: rgba(0,0,0,0);
                -webkit-transform: translateZ(0);
                -moz-transform: translateZ(0);
                -ms-transform: translateZ(0);
                -o-transform: translateZ(0);
                transform: translateZ(0);
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                -webkit-text-size-adjust: none;
                -moz-text-size-adjust: none;
                -ms-text-size-adjust: none;
                -o-text-size-adjust: none;
                text-size-adjust: none;
            }
        </style>
        
        
        
    </head>
    <body onload="loaded()">
        
                <video class="video js-video" muted="" style="display: none;">
                    <source src="http://www.quirksmode.org/html5/videos/big_buck_bunny.webm" type="video/webm">
                    <source src="http://www.quirksmode.org/html5/videos/big_buck_bunny.mp4" type="video/mp4">
                    <source src="http://www.quirksmode.org/html5/videos/big_buck_bunny.ogv" type="video/ogg">
                    Your browser does not support HTML5 video.
                </video>

        
        <div id="wrapper">
            <div id="scroller">
                <div style="background-color: green;width: 200px;height: 200px;"></div>
                <canvas class="canvas js-canvas" width="1600" height="900"></canvas>
            </div>
        </div>
        
        <script>
        var canvasVideo = new CanvasVideoPlayer({
                                videoSelector: '.js-video',
                                canvasSelector: '.js-canvas',
                                audio: !true,
                            });
        </script>

        <div style='width:100%;height:100%;pointer-events:none;position:absolute;z-index:1'>
            <!-- Fő táblázat a GUI elemek igazításához. -->
            <table border=0 cellSpacing=0 cellPadding=0 style='width:100%;height:100%;'>
                <tr style='width:100%;'>
                    <td style='padding:5px;'><b><big><div id=userNameDiv style='cursor:default;pointer-events:auto;background-color:gray;white-space:nowrap;width:auto;-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;'></div></big></b></td>
                    <td style='width:100%;'></td>
                    <td align=right><a href='/logout' class='link-button'>#!LOGOUT!#</a></td></tr>
                <tr style='height:100%;'>
                    <td colSpan=3 vAlign=bottom> <div id='chatMsgBox' class='chat-messages' style='display: table-cell; vertical-align: bottom;margin-left:5px;overflow:hidden;max-width:20%;max-height:70%;'></div></td>
                </tr>
                <tr>
                    <td colSpan=3>
                        <table border=0 cellSpacing=0 cellPadding=0 style='width:100%;height:100%;'>
                            <tr style='pointer-events:auto;cursor:default;background-color:gray;width:100%;'>
                                <td style='padding:5px;border-top:1px solid black;-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;'>
                                    #!MESSAGE!#:
                                </td>
                                <td style='width:100%;padding:5px;border-top:1px solid black;'>
                                    <input type='text' id='chatInput' maxlength='100' style='width:calc(100% - 10px);'>
                                </td>
                                <td style='padding:5px;border-top:1px solid black;'>
                                    <input id='sendChatMsgButton' type='button' value='#!SEND_MESSAGE!#'>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>


        <script>
            // Üzenet érkezett.
            function isJSON(text) {
                try {
                    JSON.parse(text);
                    return true;
                } catch (error) {
                    return false;
                }
            }
            ;
            var handleResponse = function (responseText) {
                if ('' !== responseText)
                    toDebug(responseText);
                if ('' === responseText || !isJSON(responseText))
                    return;
                // Üzenet átalakítása.
                var response = JSON.parse(responseText);
                for (var i in response) {
                    var o = response[i];
                    switch (o['a']) {
                        // Játékállapotváltozás érkezett (GameStateChanged).
                        case 'gsc':
                            toDebug('game state changed to: ' + o['d']['state']);
                            var state = o['d']['state'];
                            // Objektumok letöltése (GetSceneData).
                            sendToServer(JSON.stringify({a: 'gsd', d: {}}));
                            break;
                            // Átirányítás érkezett (ReDirect).
                        case 'rd':
                            toDebug('redirected to: ' + o['d']['url']);
                            window.location.href = o['d']['url'];
                            break;
                            // Chat üzenet érkezett (ChatMessage).
                        case 'cm':
                            var cmb = document.getElementById('chatMsgBox');
                            var count = (cmb.innerHTML.match(/<br>/g) || []).length;
                            if (count === messagesCount)
                                cmb.innerHTML = cmb.innerHTML.substring(cmb.innerHTML.indexOf('<br>') + 4);
                            if (downloadinMessages) {
                                cmb.innerHTML = "";
                                downloadinMessages = false;
                            }
                            cmb.innerHTML = cmb.innerHTML + '<b><u>' + o['d']['user'] + '</u></b>: ' + unescape(o['d']['msg']) + '<br>';
                            cmb.scrollTop = cmb.scrollHeight;
                            break;
                    }
                }
            };
            
        </script>


        <script>
            var chatMsgBox = document.getElementById('chatMsgBox');
            var chatInput = document.getElementById('chatInput');
            chatInput.focused = false;
            chatInput.hasFocus = function () {
                return this.focused;
            };
            chatInput.onfocus = function () {
                this.focused = true;
            };
            chatInput.onblur = function () {
                this.focused = false;
            };
            var sendChatMsgButton = document.getElementById('sendChatMsgButton');
            var userNameDiv = document.getElementById('userNameDiv');
            userNameDiv.innerHTML = unescape('#!PLAYER_NAME!#');
            var sendMsgFunc = function () {
                if ('' !== chatInput.value) {
                    sendToServer(JSON.stringify({a: 'cm', d: {msg: escape(chatInput.value)}}));
                    chatInput.value = '';
                }
            };
            sendChatMsgButton.onclick = function () {
                sendMsgFunc();
            };
            // Enter lenyomása az üzenet beírásához/elküldéséhez.
            document.body.addEventListener('keydown', function (e) {
                if (13 === e.keyCode) {
                    if (!chatInput.hasFocus()) {
                        chatInput.focus();
                        return;
                    }
                    sendMsgFunc();
                    chatInput.blur();
                }
            });
        </script>

        <script>
            chatMsgBox.innerHTML = unescape('#!DOWNLOADING_CHAT_MESSAGES!#');
            var downloadinMessages = true;
            // Egyszerre megjelenő üzenetek száma.
            var messagesCount = 20;

            // Játékadatok szinkronizálása.
            function syncData() {
                // Chat üzenetek letöltése (GetChatMessages).
                sendToServer(JSON.stringify({a: 'gcm', d: {mc: messagesCount}}));
                // Játékállapot letöltése (GetGameState).
                sendToServer(JSON.stringify({a: 'ggs', d: {}}));
            }

            // Long-pollin megkezdése.
            lp();

        </script>

    </body>
</html>