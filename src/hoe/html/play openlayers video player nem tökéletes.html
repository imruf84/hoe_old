<!-- video lejátszás openlayersben: https://leafletjs.com/examples/video-overlay/example.html -->
<!-- video lejátszás openlayersben: https://codepen.io/anon/pen/GWQqzj -->
<!-- video lejátszás canvason (hang nincs): http://stanko.github.io/html-canvas-video-player/ -->


<!DOCTYPE html>
<html>
    <head>
        <title>Static Image</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="stylesheet" href="ol.css" type="text/css">
        <style>html, body {width:100%;height:100%;margin:0;padding:0;border:0;overflow:hidden;font-size:100%;font-family:monospace;color:black;}</style>
        <script src="ol.js"></script>

        <script src="canvas-video-player.js"></script>
        <script>
            function scrollTopLeft() {
                var d = document.body;
                d.scrollLeft = 0;
                d.scrollTop = 0;
            }
            ;
            document.addEventListener('gesturestart', function (e) {
                scrollTopLeft();
                e.preventDefault();
            });
            document.addEventListener('touchmove',
                    function (event) {
                        scrollTopLeft();
                        event.preventDefault();
                    }, false);
        </script>

        <script>
            // Debug.
            //var debug = true;
            var debug = '#!DEBUG_ENABLED!#' === 'true' ? true : false;
            function toDebug(msg) {
                if (debug)
                    console.log('DEBUG: ' + msg);
            }
            ;

            function init() {
                toDebug('init();');
            }
            ;

        </script>

        <style>
            /* Link formázása gombbá. */
            .link-button {
                pointer-events: auto;
                background-color: black;
                border: 1px solid white;
                border-radius: 2px;
                color: black;
                padding: 10px 10px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 15px;
                margin: 2px 2px;
                -webkit-transition-duration: 0.15s;
                transition-duration: 0.15s;
                cursor: default;
                color: white;
                font-family: monospace;
                -webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;
            }
            .link-button:hover {
                background-color: white;
                color: black;
            }
            .link-button:active {
                text-decoration: underline;
            }
            .solid {
                background-color: lightgray;
            }
            .fitwidth {
                width:1%;
                white-space:nowrap;
            }
            .expandwidth {
                width:100%;
            }
            .header {
                border-bottom: 1px solid black;
            }
            .footer {
                border-top:1px solid black;
            }
            .sider {
                border-top:1px solid black;
                border-right:1px solid black;
            }
            .chat-messages {
                cursor: default;
                width: 40%;
                height: 70%;
                pointer-events: none;
                -webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;
                background: rgba(255, 255, 255, .7);
            }
        </style>
    </head>
    <!--
    <body style="zoom: 1">
    <body>
    -->

    <body onload="canvasVideo.play()">

        <!-- Játéktér tárolója. -->
        <div id="map" class="map" style="top:0;left:0;position:absolute;width:100%;height:100%;"></div>

        <div style='width:100%;height:100%;pointer-events:none;position:absolute;z-index:1'>
            <!-- Fő táblázat a GUI elemek igazításához. -->
            <table border=0 cellSpacing=0 cellPadding=0 style='width:100%;height:100%;'>
                <tr style='width:100%;'>
                    <td style='padding:5px;'><b><big><div id=userNameDiv style='cursor:default;pointer-events:auto;background-color:gray;white-space:nowrap;width:auto;-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;'></div></big></b></td>
                    <td style='width:100%;'></td>
                    <td align=right><a href='/logout' class='link-button'>#!LOGOUT!#</a></td></tr>
                <tr style='height:100%;'>
                    <td colSpan=3 vAlign=bottom> <div id='chatMsgBox' class='chat-messages' style='display: table-cell; vertical-align: bottom;margin-left:5px;overflow:hidden;max-width:20%;max-height:70%;'></div></td>
                </tr>
                <tr>
                    <td colSpan=3>
                        <table border=0 cellSpacing=0 cellPadding=0 style='width:100%;height:100%;'>
                            <tr style='pointer-events:auto;cursor:default;background-color:gray;width:100%;'>
                                <td style='padding:5px;border-top:1px solid white;-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;'>
                                    #!MESSAGE!#:
                                </td>
                                <td style='width:100%;padding:5px;border-top:1px solid white;'>
                                    <input type='text' id='chatInput' maxlength='100' style='width:calc(100% - 10px);'>
                                </td>
                                <td style='padding:5px;border-top:1px solid white;'>
                                    <input id='sendChatMsgButton' type='button' value='#!SEND_MESSAGE!#'>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>





<!--        <div class="video-wrapper js-video-wrapper">
            <div class="video-responsive">-->
                <video class="video js-video" muted="" style="display: none;">
                    <source src="http://www.quirksmode.org/html5/videos/big_buck_bunny.webm" type="video/webm">
                    <source src="http://www.quirksmode.org/html5/videos/big_buck_bunny.mp4" type="video/mp4">
                    <source src="http://www.quirksmode.org/html5/videos/big_buck_bunny.ogv" type="video/ogg">
                    Your browser does not support HTML5 video.
                </video>
<!--
                <canvas class="canvas js-canvas" width="800" height="450"></canvas>
-->
<!--            </div>
        </div>
-->


        <script>
            // Üzenet érkezett.
            function isJSON(text) {
                try {
                    JSON.parse(text);
                    return true;
                } catch (error) {
                    return false;
                }
            }
            ;
            var handleResponse = function (responseText) {
                if ('' !== responseText)
                    toDebug(responseText);
                if ('' === responseText || !isJSON(responseText))
                    return;
                // Üzenet átalakítása.
                var response = JSON.parse(responseText);
                for (var i in response) {
                    var o = response[i];
                    switch (o['a']) {
                        // Játékállapotváltozás érkezett (GameStateChanged).
                        case 'gsc':
                            toDebug('game state changed to: ' + o['d']['state']);
                            var state = o['d']['state'];
                            // Objektumok letöltése (GetSceneData).
                            sendToServer(JSON.stringify({a: 'gsd', d: {}}));
                            break;
                            // Átirányítás érkezett (ReDirect).
                        case 'rd':
                            toDebug('redirected to: ' + o['d']['url']);
                            window.location.href = o['d']['url'];
                            break;
                            // Chat üzenet érkezett (ChatMessage).
                        case 'cm':
                            var cmb = document.getElementById('chatMsgBox');
                            var count = (cmb.innerHTML.match(/<br>/g) || []).length;
                            if (count === messagesCount)
                                cmb.innerHTML = cmb.innerHTML.substring(cmb.innerHTML.indexOf('<br>') + 4);
                            if (downloadinMessages) {
                                cmb.innerHTML = "";
                                downloadinMessages = false;
                            }
                            cmb.innerHTML = cmb.innerHTML + '<b><u>' + o['d']['user'] + '</u></b>: ' + unescape(o['d']['msg']) + '<br>';
                            cmb.scrollTop = cmb.scrollHeight;
                            break;
                    }
                }
            };
            // Long-polling.
            var syncNeeded = true;
            var lp = function () {
                toDebug('openResponseChannel()');
                var xhrlp = new XMLHttpRequest();
                xhrlp.open('POST', '/play', true);
                xhrlp.responseType = 'text';
                xhrlp.onreadystatechange = function (oEvent) {
                    if (xhrlp.readyState === 4) {
                        if (xhrlp.status === 200) {
                            handleResponse(xhrlp.responseText);
                        } else {
                            toDebug('Error:', xhrlp.statusText);
                            syncNeeded = true;
                            xhrlp.abort();
                        }
                        lp();
                    }
                };
                xhrlp.timeout = 0;

                // Ha megszakadt a kapcsolat, vagy elsőként küldünk üzenetet akkor szinkronizáljuk az adatokat.
                if (syncNeeded) {
                    syncNeeded = false;
                    syncData();
                }

                // Üres üzenet küldése a válaszcsatornához.
                xhrlp.send('');
            };

            // Üzenet küldése a szervernek.
            var sendToServer = function (text) {
                toDebug('sendToServer(' + text + ');');
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/play', true);
                xhr.responseType = 'text';
                xhr.onload = function () {
                    handleResponse(xhr.responseText);
                };
                xhr.send(text);
            };
        </script>


        <script>
            var chatMsgBox = document.getElementById('chatMsgBox');
            var chatInput = document.getElementById('chatInput');
            chatInput.focused = false;
            chatInput.hasFocus = function () {
                return this.focused;
            };
            chatInput.onfocus = function () {
                this.focused = true;
            };
            chatInput.onblur = function () {
                this.focused = false;
            };
            var sendChatMsgButton = document.getElementById('sendChatMsgButton');
            var userNameDiv = document.getElementById('userNameDiv');
            userNameDiv.innerHTML = unescape('#!PLAYER_NAME!#');
            var sendMsgFunc = function () {
                if ('' !== chatInput.value) {
                    sendToServer(JSON.stringify({a: 'cm', d: {msg: escape(chatInput.value)}}));
                    chatInput.value = '';
                }
            };
            sendChatMsgButton.onclick = function () {
                sendMsgFunc();
            };
            // Enter lenyomása az üzenet beírásához/elküldéséhez.
            document.body.addEventListener('keydown', function (e) {
                if (13 === e.keyCode) {
                    if (!chatInput.hasFocus()) {
                        chatInput.focus();
                        return;
                    }
                    sendMsgFunc();
                    chatInput.blur();
                }
            });
        </script>

        <script>
            chatMsgBox.innerHTML = unescape('#!DOWNLOADING_CHAT_MESSAGES!#');
            var downloadinMessages = true;
            // Egyszerre megjelenő üzenetek száma.
            var messagesCount = 20;

            // Játékadatok szinkronizálása.
            function syncData() {
                // Chat üzenetek letöltése (GetChatMessages).
                sendToServer(JSON.stringify({a: 'gcm', d: {mc: messagesCount}}));
                // Játékállapot letöltése (GetGameState).
                sendToServer(JSON.stringify({a: 'ggs', d: {}}));
            }

            // Long-pollin megkezdése.
            lp();

        </script>

        <script>

            // https://openlayers.org/en/latest/apidoc/ol.Map.html


            var imgWidth = 2048;
            var imgHeight = 2048;
            var imgCenter = [imgWidth / 2, -imgHeight / 2];
            var extent = [0, 0, imgWidth, imgHeight];
            var projection = new ol.proj.Projection({
                code: 'aaa',
                units: 'pixels'
                , extent: extent
            });


            var defaultStyle = new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#0d47a1',
                    width: 4
                }),
                fill: new ol.style.Stroke({
                    color: 'rgba(0,255,0,.2)'
                }),
                image: new ol.style.Circle({
                    radius: 50,
                    stroke: new ol.style.Stroke({
                        color: '#0d47a1',
                        width: 2
                    })
                })
            });

            var hoverStyle = new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#0d47a1',
                    width: 6
                }),
                fill: new ol.style.Stroke({
                    color: 'rgba(0,255,0,1)'
                }),
                image: new ol.style.Circle({
                    radius: 50,
                    stroke: new ol.style.Stroke({
                        color: '#0d47a1',
                        width: 6
                    })
                })
            });

            var selectStyle = new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#0d47a1',
                    width: 6
                }),
                fill: new ol.style.Stroke({
                    color: 'rgba(255,0,0,1)'
                }),
                image: new ol.style.Circle({
                    radius: 50,
                    stroke: new ol.style.Stroke({
                        color: '#0d47a1',
                        width: 6
                    })
                })
            });



            var layerPoint = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [
                        new ol.Feature({geometry: new ol.geom.Point([0, 0])}),
                        new ol.Feature({geometry: new ol.geom.Point([100, 0])})
                    ]
                }),
                style: defaultStyle
            });

            var layerLine = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [new ol.Feature({
                            geometry: new ol.geom.LineString([
                                [0, 0],
                                [1000, 1000]
                            ])
                        })]
                }),
                style: defaultStyle
            });

            var layerPoly = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [new ol.Feature({
                            geometry: new ol.geom.Polygon([
                                [
                                    [1000, 0],
                                    [1000, 1000],
                                    [0, 1000],
                                    [0, 0]
                                ]
                            ])
                        })]
                }),
                style: defaultStyle
            });

            var layerCircle = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [new ol.Feature({
                            geometry: new ol.geom.Circle([1200, -50], 100)
                        })]
                }),
                style: defaultStyle
            });

            var imgLayer = new ol.layer.Image({
                source: new ol.source.ImageStatic({
                    url: 'http://www.duber.cz/dump/uv_map_reference.jpg',
                    projection: projection,
                    imageExtent: extent
                })
            });


            var canvasVideo = null;
            var map = null;
            var canvas = document.createElement('canvas');
            //var canvas = document.getElementsByClassName('canvas js-canvas')[0];

            var canvasLayer = null;
            canvasLayer = new ol.layer.Image({
                projection: projection,
                source: new ol.source.ImageCanvas({
                    canvasFunction: function (extent, resolution, pixelRatio, size, projection) {

                        canvas.width = size[0];
                        canvas.height = size[1];

                        if (canvasVideo === null) {
                            console.log('canvasLayer', size);
                            console.log('canvasVideo');
                            canvasVideo = new CanvasVideoPlayer({
                                videoSelector: '.js-video',
                                //canvasSelector: '.js-canvas',
                                canvasSelector: canvas,
                                //canvasSelector: '.ol-unselectable',
                                //canvasSelector: '.map',
                                //timelineSelector: '.js-timeline',
                                audio: true,
                                map: map,
                                canvasLayer: canvasLayer
                            });
                        }

                        return canvas;
                    }
                })});

            //imgLayer.on('postcompose', function (event) {
            canvasLayer.on('postcompose', function (event) {
                
                var ctx = event.context;
                ctx.save();
                ctx.scale(ol.has.DEVICE_PIXEL_RATIO, ol.has.DEVICE_PIXEL_RATIO);

                var origo = map.getPixelFromCoordinate([0, 0]);
                var size = map.getPixelFromCoordinate([800, 450]);
                //ctx.fillRect(origo[0], origo[1], size[0] - origo[0], size[1] - origo[1]);
                ctx.drawImage(canvasVideo.video, origo[0], origo[1], size[0] - origo[0], size[1] - origo[1]);

                ctx.restore();
                
                //console.log('openLayers',map.getPixelFromCoordinate([0, 0]));
                
                //console.log(ctx.currentTransform)
                
                //canvasVideo.drawRect = [origo[0], origo[1], size[0] - origo[0], size[1] - origo[1]];
                //console.log(canvasVideo.drawRect);
            });

            map = new ol.Map({
                target: 'map',
                controls: [],
                featureEvents: true,
                layers: [
                    //imgLayer,
                    canvasLayer,
                    //layerPoly, layerPoint, layerLine, layerCircle
                ],
                view: new ol.View({
                    enableRotation: false,
                    projection: projection,
                    center: ol.extent.getCenter(extent),
                    //extent: [0, 0, imgWidth, imgHeight],
                    //zoom: 1.5,
                    zoom: 1,
                    //minZoom: 1.5,
                    maxZoom: 8
                })
            });

            /*            $(function () {
             console.log('play video');
             canvasVideo.play();
             });*/

            /*            window.onresize = function (event)
             {
             mymap.updateSize();
             }
             
             $(function () {
             setTimeout(updatemap, 200);
             function updatemap() {
             map.updateSize();
             }
             });*/

            var highlightedFeatures = [];
            map.on('pointermove', function (e) {

                if (e.dragging) {
                    return;
                }

                var i;
                for (i = 0; i < highlightedFeatures.length; i++) {
                    highlightedFeatures[i].setStyle(defaultStyle);
                }
                highlightedFeatures = [];
                map.forEachFeatureAtPixel(e.pixel, function (feature) {
                    feature.setStyle(hoverStyle);
                    highlightedFeatures.push(feature);
                });
            });

            map.on('singleclick', function (e) {

                var i;
                for (i = 0; i < highlightedFeatures.length; i++) {
                    highlightedFeatures[i].setStyle(defaultStyle);
                }
                highlightedFeatures = [];
                map.forEachFeatureAtPixel(e.pixel, function (feature) {
                    feature.setStyle(selectStyle);
                    highlightedFeatures.push(feature);
                });
            });


            //change cursor on hover
            /*var target = map.getTarget(),
             jTarget = typeof target === "string" ? $("#" + target) : $(target);
             $(map.getViewport()).on('mousemove', function(e) {
             var pixel = map.getEventPixel(e.originalEvent);
             var hit = map.forEachFeatureAtPixel(pixel, function() {
             return true;
             });
             if (hit) {
             jTarget.css("cursor", "pointer");
             } else {
             jTarget.css("cursor", "");
             }
             });*/


        </script>

    </body>
</html>